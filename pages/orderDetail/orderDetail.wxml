<view class="container" wx:if="{{order}}">
  <view class="order-card">
    <view class="order-header">
      <text class="device">设备：{{order.device}}</text>
      <text class="status">状态：{{statusText}}</text>
    </view>

    <view class="order-body">
      <text class="line">问题：{{order.issue}}</text>
      <text class="line">客户：{{order.customer}}</text>
      <text class="line">电话：{{order.phone || '未填写'}}</text>
      <text class="line">地址：{{order.address || '未填写'}}</text>
      <text class="line">下单时间：{{order.time}}</text>
      <text class="line">师傅：{{order.technicianName}}</text>
    </view>

    <!-- 现场图片 -->
    <view wx:if="{{order && order.images && order.images.length}}" class="section">
      <view class="section-title">现场图片</view>

      <view class="img-grid">
        <block wx:for="{{order.images}}" wx:key="*this" wx:for-item="url" wx:for-index="idx">
          <view class="img-cell">
            <image
              class="thumb"
              src="{{url}}"
              mode="aspectFill"
              data-index="{{idx}}"
              catchtap="previewAt"
              lazy-load="true"
            />
          </view>
        </block>
      </view>
    </view>
  </view>

  <!-- 签到记录 -->
  <view class="order-card" wx:if="{{order.checkins && order.checkins.length}}">
    <view class="order-header"><text>签到记录</text></view>
    <view class="order-body">
      <block wx:for="{{order.checkins}}" wx:key="time">
        <text class="line">{{item.time}} {{item.address || (item.lat + ',' + item.lng)}}（{{item.technicianName}}）</text>
      </block>
    </view>
  </view>

<!-- 评价按钮（二选一） -->
<button wx:if="{{role==='customer' && order.status==='done' && !hasMyReview}}"
        type="primary" bindtap="goReview">去评价</button>

<button wx:if="{{role==='customer' && order.status==='done' && hasMyReview}}"
        type="primary" bindtap="goAppendReview">追加评价</button>

<button
  wx:if="{{role==='customer' && (order.status==='pending' || order.status==='offered')}}"
  class="cancel-btn"
  bindtap="cancelOrder"
>取消订单</button>

<!-- 评价列表（如有） -->
<view wx:if="{{reviews.length}}" style="margin-top:16rpx;">
  <view style="font-weight:600;margin-bottom:8rpx;">评价</view>
  <block wx:for="{{reviews}}" wx:key="time">
    <view style="background:#fff;border-radius:12rpx;padding:16rpx;margin-bottom:12rpx;">
      <view style="display:flex;justify-content:space-between;">
        <text>{{item.customerName || '匿名'}}</text>
        <text style="color:#999;">{{item.time}}</text>
      </view>
      <view style="margin:6rpx 0;">
        <view class="stars">
          <!-- 点亮的星 -->
          <block wx:for="{{item.rating}}" wx:key="*this">
            <text style="color:#ffb400;">★</text>
          </block>

          <!-- 灰色的星 -->
          <block wx:for="{{5 - item.rating}}" wx:key="*this">
            <text style="color:#ddd;">★</text>
          </block>
        </view>
      </view>
      <view style="color:#333;">{{item.content}}</view>
      <view wx:if="{{item.images && item.images.length}}" style="display:flex;gap:8rpx;flex-wrap:wrap;margin-top:8rpx;">
        <image wx:for="{{item.images}}" wx:key="*this" src="{{item}}" mode="aspectFill" style="width:160rpx;height:160rpx;border-radius:8rpx;" />
      </view>
    </view>
  </block>
</view>

<!-- 师傅端：到场签到（仅已接单且是当前师傅本人） -->
<button wx:if="{{role==='technician' && order.status==='assigned' && order.technicianId===userId}}"
        type="primary" bindtap="checkin">到场签到</button>
</view>

<!-- 师傅端：发起完成（仅当已签到） -->
<view wx:if="{{role==='technician'}}" class="section">
  <button
    class="primary-btn"
    bindtap="requestComplete"
    wx:if="{{order.status==='checkedIn'}}"
  >发起完成（待客户确认）</button>

  <button
    class="primary-btn disabled"
    wx:if="{{order.status!=='checkedIn' && order.status!=='done'}}"
    disabled="true"
  >需先到场签到后才能完成</button>
</view>

<!-- 客户端：确认完成（仅当待确认） -->
<view wx:if="{{role==='customer' && order.status==='awaitingConfirm'}}" class="section">
  <button class="primary-btn" bindtap="confirmComplete">确认完成</button>
</view>

<!-- 状态提示（可选）：展示“待确认” -->
<view wx:if="{{order.status==='awaitingConfirm'}}" class="hint">
  订单已由师傅发起完成，等待客户确认
  <text class="sub">（确认后即可去评价）</text>
</view>

<!-- 仅师傅 & 已完成 才显示“查看用户评价” -->
<view wx:if="{{role==='technician' && order.status==='done'}}" class="section">
  <button class="primary-btn" bindtap="goTechViewReview">查看用户评价</button>
</view>
